# 深入ESP32睡眠模式及功耗
毫无疑问的一点是，上海乐鑫的ESP系列芯片是非常成功的。从其ESP8266系列到现在的ESP32系列都是一个一个的奇迹，从国内到国外基本上物联网类型项目都有他们的存在。

当我们的项目是插电型的项目时，我们往往是不用考虑功耗的，但是当我们的设备是使用电池供电的时候功耗是非常严重插电问题，每一毫安的都显得那么重要。

我们这次探讨一下，ESP32的各种睡眠模式及各模式下的功耗问题。

::: tip
什么是 ESP32 睡眠模式？

ESP32 睡眠模式是一种省电状态，当芯片没有进入睡眠模式的时候，数据都是存储到RAM中。当 ESP32 进入睡眠模式时，任何不需要的数字外围设备的电源都会被切断，此时数据将会存储至RTC中。
:::


## 1. ESP32芯片内部框图

为了了解ESP32如何实现省电，我们需要知道芯片内部是什么。下图为 ESP32 芯片的功能框图。

<div >
    <img :src="$withBase('/esp32sleepmode/Block-Diagrams.png')" >
</div>

ESP32具有双核32位微处理器，以及448KB ROM520KB SRAM和4MB闪存。它还包含 WiFi 模块、蓝牙模块、加密加速器（专为执行加密操作而设计的协处理器）、RTC 模块和许多外围设备。

## 2. ESP32 电源模式

得益于 ESP32 的高级电源管理，它提供了5 种可配置的电源模式。根据功率要求，芯片可以在不同的功率模式之间切换。模式是：

+ 主动模式
+ 调制解调器睡眠模式
+ 轻度睡眠模式
+ 深度睡眠模式
+ 休眠模式

### 2.1 主动模式

正常模式也称为主动模式（默认情况下如果没有做任何指定都是工作在此模式下）。在这种模式下，芯片的所有功能都处于活动状态。

由于主动模式使一切（尤其是 WiFi 模块、处理内核和蓝牙模块）始终处于开启状态，因此芯片需要超过 240mA 的电流才能运行。我们还观察到，如果同时使用 WiFi 和蓝牙功能，有时会出现高功率尖峰（最大为 790mA）。

<div >
    <img :src="$withBase('/esp32sleepmode/ESP32-Active-Mode-Functional-Block-Diagram.png')" >
</div>

同时，由于使用蓝牙或者WiFi，在此情况下功耗大致如下


|模式|能量消耗|
|-----|------|
|Wi-Fi Tx 数据包 13dBm~21dBm	|160~260mA|
|Wi-Fi/BT Tx 数据包 0dBm	|120mA|
|Wi-Fi/BT Rx 和收听	|80~90mA|

显然，此时性能是最强的，但是功耗是最大的。如果我们想节省电力，我们必须在不使用某些功能时时禁用它们（通过利用其他电源模式之一）。

### 2.2 调制解调器睡眠模式

在调制解调器睡眠模式下，一切都处于活动状态，而只有 WiFi、蓝牙和无线电被禁用。CPU 也可以运行并且时钟是可配置的。
在这种模式下，芯片在低速时消耗大约 3mA，在高速时消耗 20mA。


<div >
    <img :src="$withBase('/esp32sleepmode/ESP32-Modem-Sleep-Functional-Block-Diagram.png')" >
</div>

为了保持 WiFi/蓝牙连接有效，CPU、Wi-Fi、蓝牙和无线电会以预定义的时间间隔唤醒。它被称为协会睡眠模式。

在此睡眠模式期间，电源模式在活动模式和调制解调器睡眠模式之间切换。

ESP32 仅在以 Station 模式连接到路由器时才能进入调制解调器睡眠模式。ESP32 通过DTIM 信标机制与路由器保持连接。

为了省电，ESP32 在两个 DTIM Beacon 间隔之间禁用 Wi-Fi 模块，并在下一个 Beacon 到达之前自动唤醒。

休眠时间由路由器的 DTIM Beacon 间隔时间决定，通常为 100ms 到 1000ms。

::: tip
什么是DTIM信标机制？
DTIM 是 Delivery Traffic Indication Message 的首字母缩写。

DTIM-信标
在这种机制中，接入点（AP）/路由器周期性地发送信标帧。每个帧都包含有关网络的所有信息。它用于宣布无线网络的存在并同步所有连接的成员。
:::

### 2.3 轻度睡眠模式

轻度睡眠模式的工作方式与调制解调器睡眠的工作方式类似，不同之处在于，在轻度睡眠模式下，数字外设、大多数 RAM 和 CPU 是时钟门控的。

在轻度睡眠模式下，CPU 通过关闭其时钟脉冲，而 RTC 和 ULP 协处理器保持活动状态。这导致比调制解调器睡眠模式下的功耗更低，电流为0.8mA。

<div >
    <img :src="$withBase('/esp32sleepmode/ESP32-Light-Sleep-Functional-Block-Diagram.png')" >
</div>

在进入浅睡眠模式之前，ESP32会保存所有状态，并在退出睡眠模式后恢复。


### 2.4 深度睡眠模式
在深度睡眠模式下，CPU、大部分 RAM 和所有数字外设都关闭。芯片上唯一保持通电的部分是：RTC 控制器、RTC 外设（包括 ULP 协处理器）和 RTC 存储器（慢速和快速）。

该芯片消耗大约 0.15 mA（如果 ULP 协处理器上电）至 10µA。

<div >
    <img :src="$withBase('/esp32sleepmode/ESP32-Deep-Sleep-Functional-Block-Diagram.png')" >
</div>

在深度睡眠模式下，主 CPU 断电，而 ULP 协处理器进行传感器测量并根据来自传感器的测量数据唤醒主系统。这种睡眠模式称为ULP传感器监控模式。

，芯片的主存储器也被禁用。因此，存储在该内存中的所有内容都将被清除且无法访问。

但是，RTC 存储器保持通电。因此，它的内容在深度睡眠期间会被保留下来，并且可以在我们唤醒芯片后进行检索。这就是原因，该芯片在禁用 Wi-Fi 和蓝牙连接数据之前将它们存储在 RTC 内存中。

因此，如果您想在重启后使用数据，请通过定义一个具有RTC_DATA_ATTR属性的全局变量将其存储到 RTC 内存中。

在深度睡眠模式下，除 RTC 模块外，整个芯片的电源都被关闭。因此，任何不在 RTC 恢复存储器中的数据都将丢失，因此芯片将通过复位重新启动。这意味着程序再次从头开始执行。

默认情况下，ESP32 会自动关闭唤醒源不需要的外围设备。但是您可以选择决定关闭/保持所有外围设备。有关更多信息，请查看乐鑫官方API文档。

### 2.5 休眠模式
与深度睡眠模式不同，在休眠模式下，芯片也会禁用内部 8MHz 振荡器和 ULP 协处理器。RTC 恢复内存也会断电，这意味着我们无法在休眠模式下保留任何数据。

除了慢时钟上只有一个 RTC 定时器和一些 RTC GPIO 处于活动状态外，其他所有功能都关闭。它们负责将芯片从休眠模式唤醒。

这进一步降低了功耗。该芯片仅在休眠模式下消耗约 2.5µA。


<div >
    <img :src="$withBase('/esp32sleepmode/ESP32-Hibernation-Mode-Functional-Block-Diagram.png')" >
</div>